<?xml version="1.0" encoding="utf-8"?>

<ContentPage xmlns="http://xamarin.com/schemas/2014/forms" xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:ffimageloading="clr-namespace:FFImageLoading.Forms;assembly=FFImageLoading.Forms"
             xmlns:fftransformations="clr-namespace:FFImageLoading.Transformations;assembly=FFImageLoading.Transformations"
             xmlns:partials="clr-namespace:AnimeViewer.Views.Partials;assembly=AnimeViewer"
             x:Class="AnimeViewer.Views.AnimePage"
             Title="Anime"
             Appearing="AnimePage_OnAppearing">
    <Grid>
        <!-- This is a background that supports urls -->
        <ffimageloading:CachedImage x:Name="CustomBackgroundImage"
                                    DownsampleHeight="50"
                                    DownsampleWidth="38"
                                    Aspect="Fill">
            <ffimageloading:CachedImage.Transformations>
                <!-- For a blurry image -->
                <fftransformations:BlurredTransformation Radius="3" />
            </ffimageloading:CachedImage.Transformations>
        </ffimageloading:CachedImage>
        <!-- Apply a dark tint over the blurry image, so its easier to read to content on it -->
        <ContentView BackgroundColor="Black"
                     Opacity="0.5" />
        <!-- What used to be your page content goes here -->
        <!-- A scrollview to scroll through all content if larger then the page (which is likely due to episodes) -->
        <ScrollView IsClippedToBounds="True"
                    VerticalOptions="FillAndExpand"
                    HorizontalOptions="FillAndExpand">
            <StackLayout>
                <!-- These are the notification frames, for example the Establishing Connection notification -->
                <!-- Notification that shows when there are connection issue(s) -->
                <Frame HasShadow="True"
                       Padding="10"
                       BackgroundColor="Transparent"
                       IsVisible="{Binding HasConnectionIssue}"
                       OutlineColor="Black">
                    <Label
                        Text="No active connection, some information might not be available and you won't be able to watch episodes"
                        VerticalOptions="Center"
                        TextColor="White"
                        HorizontalOptions="CenterAndExpand"
                        HorizontalTextAlignment="Center"
                        FontSize="Small" />
                </Frame>
                <!-- Anime Name -->
                <Label HorizontalOptions="Center"
                       TextColor="White"
                       Margin="10"
                       FontSize="Large"
                       HorizontalTextAlignment="Center"
                       Text="{Binding Anime.Name}" />
                <Grid Padding="15" ColumnSpacing="10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="2*" />
                    </Grid.ColumnDefinitions>
                    <!-- Poster Image of the anime -->
                    <ffimageloading:CachedImage Source="{Binding Anime.ImageUrl}"
                                                HorizontalOptions="FillAndExpand"
                                                VerticalOptions="FillAndExpand" />
                    <StackLayout Grid.Column="1">
                        <!-- Some more detailed information will be shown here -->
                        <Label Text="Other Information"
                               FontSize="Small" />
                    </StackLayout>
                </Grid>
                <!-- Summary of the anime -->
                <Label Text="{Binding Anime.Summary}"
                       FontSize="Small"
                       TextColor="#999999"
                       Margin="25" />
                <!-- Episodes and an activityindicator when the list is empty -->
                <Grid VerticalOptions="FillAndExpand"
                      HorizontalOptions="FillAndExpand">
                    <ContentView BackgroundColor="Black"
                                 Opacity="0.2" />
                    <ActivityIndicator VerticalOptions="Center"
                                       HorizontalOptions="Center"
                                       IsRunning="True"
                                       IsVisible="False">
                        <ActivityIndicator.Triggers>
                            <DataTrigger TargetType="ActivityIndicator"
                                         Binding="{Binding Anime.Episodes}"
                                         Value="{x:Null}">
                                <Setter Property="IsVisible"
                                        Value="True" />
                            </DataTrigger>
                        </ActivityIndicator.Triggers>
                    </ActivityIndicator>
                    <!-- The episode list -->
                    <ListView BackgroundColor="Transparent"
                              x:Name="ListView"
                              Margin="10"
                              VerticalOptions="FillAndExpand"
                              HorizontalOptions="FillAndExpand"
                              RowHeight="50"
                              ItemTapped="Episode_Tapped"
                              ItemsSource="{Binding Anime.Episodes}">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <ViewCell>
                                    <StackLayout BackgroundColor="Transparent"
                                                 HorizontalOptions="Center"
                                                 VerticalOptions="Center">
                                        <StackLayout.Triggers>
                                            <!-- Change backgroundcolor if watched TODO: NOT WORKING -->
                                            <DataTrigger TargetType="StackLayout"
                                                         Binding="{Binding HasWatched}"
                                                         Value="True">
                                                <Setter Property="BackgroundColor"
                                                        Value="Green" />
                                            </DataTrigger>
                                        </StackLayout.Triggers>
                                        <!-- The episode text -->
                                        <Label Text="{Binding Name}"
                                               TextColor="White"
                                               HorizontalOptions="Center"
                                               HorizontalTextAlignment="Center"
                                               VerticalOptions="Center" />
                                    </StackLayout>
                                </ViewCell>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </Grid>
            </StackLayout>
        </ScrollView>
    </Grid>
</ContentPage>